<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FoundationDB</span><span class="hs-operator">.</span><span class="hs-identifier">Transaction</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>  </span><span class="hs-comment">-- * Transactions</span><span>
</span><a name="line-11"></a><span>    </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#runTransaction"><span class="hs-identifier hs-var">runTransaction</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#runTransaction%27"><span class="hs-identifier hs-var">runTransaction'</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#defaultConfig"><span class="hs-identifier hs-var">defaultConfig</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#runTransactionWithConfig"><span class="hs-identifier hs-var">runTransactionWithConfig</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#runTransactionWithConfig%27"><span class="hs-identifier hs-var">runTransactionWithConfig'</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#cancel"><span class="hs-identifier hs-var">cancel</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#reset"><span class="hs-identifier hs-var">reset</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#withSnapshot"><span class="hs-identifier hs-var">withSnapshot</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#setOption"><span class="hs-identifier hs-var">setOption</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getReadVersion"><span class="hs-identifier hs-var">getReadVersion</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#setReadVersion"><span class="hs-identifier hs-var">setReadVersion</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getVersionstamp"><span class="hs-identifier hs-var">getVersionstamp</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#set"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#clear"><span class="hs-identifier hs-var">clear</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#clearRange"><span class="hs-identifier hs-var">clearRange</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#addConflictRange"><span class="hs-identifier hs-var">addConflictRange</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FDBConflictRangeType"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">FDBConflictRangeType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#addReadConflictKey"><span class="hs-identifier hs-var">addReadConflictKey</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#addWriteConflictKey"><span class="hs-identifier hs-var">addWriteConflictKey</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getKey"><span class="hs-identifier hs-var">getKey</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getKeyAddresses"><span class="hs-identifier hs-var">getKeyAddresses</span></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#atomicOp"><span class="hs-identifier hs-var">atomicOp</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getRange"><span class="hs-identifier hs-var">getRange</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getRange%27"><span class="hs-identifier hs-var">getRange'</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FDBStreamingMode"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">FDBStreamingMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getEntireRange"><span class="hs-identifier hs-var">getEntireRange</span></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getEntireRange%27"><span class="hs-identifier hs-var">getEntireRange'</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#isRangeEmpty"><span class="hs-identifier hs-var">isRangeEmpty</span></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#rangeKeys"><span class="hs-identifier hs-var">rangeKeys</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#keyRange"><span class="hs-identifier hs-var">keyRange</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#keyRangeInclusive"><span class="hs-identifier hs-var">keyRangeInclusive</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#prefixRange"><span class="hs-identifier hs-var">prefixRange</span></a><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#prefixRangeEnd"><span class="hs-identifier hs-var">prefixRangeEnd</span></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#RangeResult"><span class="hs-identifier hs-type">RangeResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#watch"><span class="hs-identifier hs-var">watch</span></a><span>
</span><a name="line-50"></a><span>  </span><span class="hs-comment">-- * Futures</span><span>
</span><a name="line-51"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span>
</span><a name="line-52"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#awaitInterruptible"><span class="hs-identifier hs-var">awaitInterruptible</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#cancelFuture"><span class="hs-identifier hs-var">cancelFuture</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#futureIsReady"><span class="hs-identifier hs-var">futureIsReady</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span>
</span><a name="line-57"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#awaitIO"><span class="hs-identifier hs-var">awaitIO</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#awaitInterruptibleIO"><span class="hs-identifier hs-var">awaitInterruptibleIO</span></a><span>
</span><a name="line-59"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#cancelFutureIO"><span class="hs-identifier hs-var">cancelFutureIO</span></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#futureIsReadyIO"><span class="hs-identifier hs-var">futureIsReadyIO</span></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-comment">-- * Key selectors</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#KeySelector"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KeySelector</span></a><span class="hs-special">(</span><span> </span><a href="FoundationDB.Internal.Bindings.html#LastLessThan"><span class="hs-identifier hs-var">LastLessThan</span></a><span>
</span><a name="line-63"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#LastLessOrEq"><span class="hs-identifier hs-var">LastLessOrEq</span></a><span>
</span><a name="line-64"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterThan"><span class="hs-identifier hs-var">FirstGreaterThan</span></a><span>
</span><a name="line-65"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#offset"><span class="hs-identifier hs-var">offset</span></a><span>
</span><a name="line-67"></a><span>  </span><span class="hs-comment">-- * Advanced Usage</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-comment">-- $advanced</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-type">TransactionEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">envConf</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#createTransactionEnv"><span class="hs-identifier hs-var">createTransactionEnv</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#onEnv"><span class="hs-identifier hs-var">onEnv</span></a><span>
</span><a name="line-72"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#commitFuture"><span class="hs-identifier hs-var">commitFuture</span></a><span>
</span><a name="line-73"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#onError"><span class="hs-identifier hs-var">onError</span></a><span>
</span><a name="line-74"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FoundationDB.Transaction.html#getCommittedVersion"><span class="hs-identifier hs-var">getCommittedVersion</span></a><span>
</span><a name="line-75"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">throwIO</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadThrow</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExceptT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftEither</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Reader</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">asks</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">local</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runReaderT</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Resource</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">allocate</span><span>
</span><a name="line-85"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadResource</span><span>
</span><a name="line-86"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">release</span><span>
</span><a name="line-87"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ReleaseKey</span><span>
</span><a name="line-88"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ResourceT</span><span>
</span><a name="line-89"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runResourceT</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromJust</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Seq</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Empty</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">:|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newForeignPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withForeignPtr</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="FoundationDB.Error.Internal.html"><span class="hs-identifier">FoundationDB</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="FoundationDB.Internal.Bindings.html"><span class="hs-identifier">FoundationDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Bindings</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">FDB</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="FoundationDB.Options.html"><span class="hs-identifier">FoundationDB</span><span class="hs-operator">.</span><span class="hs-identifier">Options</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Opt</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><a href="FoundationDB.Versionstamp.html"><span class="hs-identifier">FoundationDB</span><span class="hs-operator">.</span><span class="hs-identifier">Versionstamp</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- | A transaction monad. This is currently exported with a 'MonadIO' instance,</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- but using it comes with caveats:</span><span>
</span><a name="line-107"></a><span class="hs-comment">--</span><span>
</span><a name="line-108"></a><span class="hs-comment">--   - 'runTransaction' will retry your transaction in some cases, which means</span><span>
</span><a name="line-109"></a><span class="hs-comment">--     any IO in your transaction will be repeated.</span><span>
</span><a name="line-110"></a><span class="hs-comment">--</span><span>
</span><a name="line-111"></a><span class="hs-comment">--   - Transactions have strict time limits, so slow IO operations should be</span><span>
</span><a name="line-112"></a><span class="hs-comment">--     avoided.</span><span>
</span><a name="line-113"></a><span class="hs-keyword">newtype</span><span> </span><a name="Transaction"><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier">Transaction</span></a></a><span> </span><a name="local-6989586621679085046"><a href="#local-6989586621679085046"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Transaction"><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier">Transaction</span></a></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-special">{</span><a name="unTransaction"><a href="FoundationDB.Transaction.html#unTransaction"><span class="hs-identifier">unTransaction</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-type">TransactionEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExceptT</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ResourceT</span><span> </span><span class="hs-identifier hs-type">IO</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085046"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">}</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span>
</span><a name="line-116"></a><span>            </span><span class="hs-identifier hs-type">MonadMask</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span class="hs-comment">-- TODO: ok to have both MonadThrow and MonadError instances?</span><span>
</span><a name="line-118"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- TODO: does this MonadReader instance need to be exposed?</span><span>
</span><a name="line-120"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-type">TransactionEnv</span></a><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span>
</span><a name="line-121"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadResource</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- | A future result of a FoundationDB call. You can block on a future with</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- 'await'.</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- WARNING: returning a value of this type from 'runTransaction' and then</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- calling 'await' on the value in another transaction will cause a segfault!</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- Future versions of this library may use more sophisticated types to prevent</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- this.</span><span>
</span><a name="line-129"></a><span class="hs-keyword">data</span><span> </span><a name="Future"><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier">Future</span></a></a><span> </span><a name="local-6989586621679085044"><a href="#local-6989586621679085044"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>  </span><a name="PureFuture"><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier">PureFuture</span></a></a><span> </span><a href="#local-6989586621679085044"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-131"></a><span>  </span><span class="hs-comment">-- ^ For applicative and monad instances</span><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679085045"><a href="#local-6989586621679085045"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a name="Future"><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier">Future</span></a></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-comment">-- TODO:the future is closed over by _extractValue. It's only included in this</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-comment">-- record so that we can more easily debug (see the Show instance, which</span><span>
</span><a name="line-135"></a><span>  </span><span class="hs-comment">-- prints the address). Given the lack of bugs so far, it is probably safe</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-comment">-- to simplify this.</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="_cFuture"><a href="FoundationDB.Transaction.html#_cFuture"><span class="hs-identifier">_cFuture</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085045"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_extractValue"><a href="FoundationDB.Transaction.html#_extractValue"><span class="hs-identifier">_extractValue</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085044"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-139"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679085066"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085066"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-142"></a><span>  </span><a name="local-8214565720323790231"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085067"><a href="#local-6989586621679085067"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Future &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679085067"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-143"></a><span>  </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085068"><a href="#local-6989586621679085068"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Future &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679085068"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-146"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679085061"><a href="#local-6989586621679085061"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085062"><a href="#local-6989586621679085062"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085061"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679085062"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>  </span><span class="hs-identifier">fmap</span><span> </span><a name="local-6989586621679085063"><a href="#local-6989586621679085063"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085064"><a href="#local-6989586621679085064"><span class="hs-identifier">cf</span></a></a><span> </span><a name="local-6989586621679085065"><a href="#local-6989586621679085065"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a href="#local-6989586621679085064"><span class="hs-identifier hs-var">cf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679085063"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679085065"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-150"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085052"><a href="#local-6989586621679085052"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>   </span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085053"><a href="#local-6989586621679085053"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085052"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679085053"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085054"><a href="#local-6989586621679085054"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-operator">&lt;*&gt;</span><span> </span><a name="local-6989586621679085055"><a href="#local-6989586621679085055"><span class="hs-identifier">fut</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679085054"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679085055"><span class="hs-identifier hs-var">fut</span></a><span>
</span><a name="line-153"></a><span>  </span><a name="local-6989586621679085056"><a href="#local-6989586621679085056"><span class="hs-identifier">fut</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085057"><a href="#local-6989586621679085057"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679085057"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085056"><span class="hs-identifier hs-var">fut</span></a><span>
</span><a name="line-154"></a><span>  </span><a name="local-6989586621679085058"><a href="#local-6989586621679085058"><span class="hs-identifier">fut</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085059"><a href="#local-6989586621679085059"><span class="hs-identifier">cf</span></a></a><span> </span><a name="local-6989586621679085060"><a href="#local-6989586621679085060"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a href="#local-6989586621679085059"><span class="hs-identifier hs-var">cf</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span> </span><a href="#local-6989586621679085058"><span class="hs-identifier hs-var">fut</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679085060"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">fromCExtractor</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085088"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ReleaseKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085089"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085089"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><a name="fromCExtractor"><a href="FoundationDB.Transaction.html#fromCExtractor"><span class="hs-identifier">fromCExtractor</span></a></a><span> </span><a name="local-6989586621679085090"><a href="#local-6989586621679085090"><span class="hs-identifier">cFuture</span></a></a><span> </span><a name="local-6989586621679085091"><a href="#local-6989586621679085091"><span class="hs-identifier">rk</span></a></a><span> </span><a name="local-6989586621679085092"><a href="#local-6989586621679085092"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a href="#local-6989586621679085090"><span class="hs-identifier hs-var">cFuture</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>  </span><a name="local-6989586621679085093"><a href="#local-6989586621679085093"><span class="hs-identifier">futErr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#futureGetError"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetError</span></a><span> </span><a href="#local-6989586621679085090"><span class="hs-identifier hs-var">cFuture</span></a><span>
</span><a name="line-160"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="FoundationDB.Error.Internal.html#toError"><span class="hs-identifier hs-var">toError</span></a><span> </span><a href="#local-6989586621679085093"><span class="hs-identifier hs-var">futErr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679085094"><a href="#local-6989586621679085094"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">release</span><span> </span><a href="#local-6989586621679085091"><span class="hs-identifier hs-var">rk</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Error.Internal.html#CError"><span class="hs-identifier hs-var">CError</span></a><span> </span><a href="#local-6989586621679085094"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-163"></a><span>      </span><a name="local-6989586621679085095"><a href="#local-6989586621679085095"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679085092"><span class="hs-identifier hs-var">extract</span></a><span>
</span><a name="line-164"></a><span>      </span><span class="hs-identifier hs-var">release</span><span> </span><a href="#local-6989586621679085091"><span class="hs-identifier hs-var">rk</span></a><span>
</span><a name="line-165"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679085095"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">allocFuture</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085086"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085086"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085087"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085087"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><a name="allocFuture"><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier">allocFuture</span></a></a><span> </span><a name="local-6989586621679085096"><a href="#local-6989586621679085096"><span class="hs-identifier">make</span></a></a><span> </span><a name="local-6989586621679085097"><a href="#local-6989586621679085097"><span class="hs-identifier">extract</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679085098"><a href="#local-6989586621679085098"><span class="hs-identifier">rk</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679085099"><a href="#local-6989586621679085099"><span class="hs-identifier">future</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">allocate</span><span> </span><a href="#local-6989586621679085096"><span class="hs-identifier hs-var">make</span></a><span> </span><a href="FoundationDB.Internal.Bindings.html#futureDestroy"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureDestroy</span></a><span>
</span><a name="line-173"></a><span>  </span><a href="FoundationDB.Transaction.html#fromCExtractor"><span class="hs-identifier hs-var">fromCExtractor</span></a><span> </span><a href="#local-6989586621679085099"><span class="hs-identifier hs-var">future</span></a><span> </span><a href="#local-6989586621679085098"><span class="hs-identifier hs-var">rk</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085097"><span class="hs-identifier hs-var">extract</span></a><span> </span><a href="#local-6989586621679085099"><span class="hs-identifier hs-var">future</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">-- | Block until a future is ready. Unfortunately, does not seem to be</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- interruptible SIGPIPE (the interrupt sent by Control.Conccurent.Async to</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- cancel), even when using InterruptibleFFI.</span><span>
</span><a name="line-178"></a><span class="hs-identifier">await</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085085"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085085"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-179"></a><a name="await"><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier">await</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085100"><a href="#local-6989586621679085100"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679085100"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-180"></a><span class="hs-identifier">await</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085101"><a href="#local-6989586621679085101"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679085102"><a href="#local-6989586621679085102"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-181"></a><span>  </span><a href="FoundationDB.Error.Internal.html#fdbExcept%27"><span class="hs-identifier hs-var">fdbExcept'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#futureBlockUntilReady"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureBlockUntilReady</span></a><span> </span><a href="#local-6989586621679085101"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-182"></a><span>  </span><a href="#local-6989586621679085102"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-comment">-- | Polls a future for readiness in a loop until it is ready, then returns</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- the value in the future. This is less resource efficient than 'await', but</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- can be interrupted more easily.</span><span>
</span><a name="line-187"></a><span class="hs-identifier">awaitInterruptible</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085084"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085084"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-188"></a><a name="awaitInterruptible"><a href="FoundationDB.Transaction.html#awaitInterruptible"><span class="hs-identifier">awaitInterruptible</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><a name="local-6989586621679085103"><a href="#local-6989586621679085103"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679085103"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-189"></a><span class="hs-identifier">awaitInterruptible</span><span> </span><a name="local-6989586621679085104"><a href="#local-6989586621679085104"><span class="hs-identifier">fut</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085105"><a href="#local-6989586621679085105"><span class="hs-identifier">_f</span></a></a><span> </span><a name="local-6989586621679085106"><a href="#local-6989586621679085106"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#futureIsReady"><span class="hs-identifier hs-var">futureIsReady</span></a><span> </span><a href="#local-6989586621679085104"><span class="hs-identifier hs-var">fut</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679085106"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-191"></a><span>  </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-number">1000</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="FoundationDB.Transaction.html#awaitInterruptible"><span class="hs-identifier hs-var">awaitInterruptible</span></a><span> </span><a href="#local-6989586621679085104"><span class="hs-identifier hs-var">fut</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- | Cancel a future. Attempts to await the future after cancellation will throw</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- 'OperationCancelled'.</span><span>
</span><a name="line-195"></a><span class="hs-identifier">cancelFuture</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085083"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><a name="cancelFuture"><a href="FoundationDB.Transaction.html#cancelFuture"><span class="hs-identifier">cancelFuture</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span class="hs-identifier">cancelFuture</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085147"><a href="#local-6989586621679085147"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679085148"><a href="#local-6989586621679085148"><span class="hs-identifier">_e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#futureCancel"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureCancel</span></a><span> </span><a href="#local-6989586621679085147"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- | Returns True if the future is ready. If so, calling 'await' will not block.</span><span>
</span><a name="line-200"></a><span class="hs-identifier">futureIsReady</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085082"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-201"></a><a name="futureIsReady"><a href="FoundationDB.Transaction.html#futureIsReady"><span class="hs-identifier">futureIsReady</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#PureFuture"><span class="hs-identifier hs-var">PureFuture</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-202"></a><span class="hs-identifier">futureIsReady</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085149"><a href="#local-6989586621679085149"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#futureIsReady"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureIsReady</span></a><span> </span><a href="#local-6989586621679085149"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- | A future that can only be awaited after its transaction has committed.</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- That is, in contrast to 'Future', this __must__ be returned from</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- 'runTransaction' before it can safely be awaited. Use 'awaitIO' to await it.</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- This future type is not needed frequently.</span><span>
</span><a name="line-208"></a><span class="hs-comment">--</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- All 'FutureIO' functions work similarly to their 'Future' counterparts.</span><span>
</span><a name="line-210"></a><span class="hs-keyword">data</span><span> </span><a name="FutureIO"><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier">FutureIO</span></a></a><span> </span><a name="local-6989586621679084821"><a href="#local-6989586621679084821"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FutureIO"><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier">FutureIO</span></a></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="_fgnPtr"><a href="FoundationDB.Transaction.html#_fgnPtr"><span class="hs-identifier">_fgnPtr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignPtr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_extractValueIO"><a href="FoundationDB.Transaction.html#_extractValueIO"><span class="hs-identifier">_extractValueIO</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679084821"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">}</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><a href="#local-6989586621679085050"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-215"></a><span>  </span><a name="local-8214565720323790231"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a name="local-6989586621679085051"><a href="#local-6989586621679085051"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;FutureIO &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679085051"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-218"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679085047"><a href="#local-6989586621679085047"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a name="local-6989586621679085048"><a href="#local-6989586621679085048"><span class="hs-identifier">cf</span></a></a><span> </span><a name="local-6989586621679085049"><a href="#local-6989586621679085049"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a href="#local-6989586621679085048"><span class="hs-identifier hs-var">cf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679085047"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679085049"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-identifier">allocFutureIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="#local-6989586621679085080"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679085081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><a href="#local-6989586621679085081"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><a name="allocFutureIO"><a href="FoundationDB.Transaction.html#allocFutureIO"><span class="hs-identifier">allocFutureIO</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Future</span></a><span> </span><a name="local-6989586621679085150"><a href="#local-6989586621679085150"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679085151"><a href="#local-6989586621679085151"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-222"></a><span>  </span><a name="local-6989586621679085183"><a href="#local-6989586621679085183"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newForeignPtr</span><span> </span><a href="FoundationDB.Internal.Bindings.html#futureDestroyPtr"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureDestroyPtr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621679085150"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a href="#local-6989586621679085183"><span class="hs-identifier hs-var">fp</span></a><span> </span><a href="#local-6989586621679085151"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-- | IO analogue to 'await'.</span><span>
</span><a name="line-226"></a><span class="hs-identifier">awaitIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><a href="#local-6989586621679085079"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="#local-6989586621679085079"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><a name="awaitIO"><a href="FoundationDB.Transaction.html#awaitIO"><span class="hs-identifier">awaitIO</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a name="local-6989586621679085184"><a href="#local-6989586621679085184"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621679085185"><a href="#local-6989586621679085185"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621679085184"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679085186"><a href="#local-6989586621679085186"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-228"></a><span>  </span><a href="FoundationDB.Error.Internal.html#fdbEither%27"><span class="hs-identifier hs-var">fdbEither'</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#futureBlockUntilReady"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureBlockUntilReady</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Future</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621679085186"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679085187"><a href="#local-6989586621679085187"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679085187"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679085185"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">-- | IO analogue to 'awaitInterruptible'.</span><span>
</span><a name="line-233"></a><span class="hs-identifier">awaitInterruptibleIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><a href="#local-6989586621679085078"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679085078"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-234"></a><a name="awaitInterruptibleIO"><a href="FoundationDB.Transaction.html#awaitInterruptibleIO"><span class="hs-identifier">awaitInterruptibleIO</span></a></a><span> </span><a name="local-6989586621679085188"><a href="#local-6989586621679085188"><span class="hs-identifier">fut</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679085189"><a href="#local-6989586621679085189"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#futureIsReadyIO"><span class="hs-identifier hs-var">futureIsReadyIO</span></a><span> </span><a href="#local-6989586621679085188"><span class="hs-identifier hs-var">fut</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679085189"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-number">1000</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="FoundationDB.Transaction.html#awaitInterruptibleIO"><span class="hs-identifier hs-var">awaitInterruptibleIO</span></a><span> </span><a href="#local-6989586621679085188"><span class="hs-identifier hs-var">fut</span></a><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-comment">-- | Cancel a future. Attempts to await the future after cancellation will throw</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- 'OperationCancelled'.</span><span>
</span><a name="line-240"></a><span class="hs-identifier">cancelFutureIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><a href="#local-6989586621679085077"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><a name="cancelFutureIO"><a href="FoundationDB.Transaction.html#cancelFutureIO"><span class="hs-identifier">cancelFutureIO</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a name="local-6989586621679085190"><a href="#local-6989586621679085190"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621679085191"><a href="#local-6989586621679085191"><span class="hs-identifier">_e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621679085190"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679085192"><a href="#local-6989586621679085192"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-242"></a><span>  </span><a href="FoundationDB.Internal.Bindings.html#futureCancel"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureCancel</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Future</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621679085192"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-identifier">futureIsReadyIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><a href="#local-6989586621679085076"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-245"></a><a name="futureIsReadyIO"><a href="FoundationDB.Transaction.html#futureIsReadyIO"><span class="hs-identifier">futureIsReadyIO</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-var">FutureIO</span></a><span> </span><a name="local-6989586621679085193"><a href="#local-6989586621679085193"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621679085193"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679085194"><a href="#local-6989586621679085194"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-246"></a><span>  </span><a href="FoundationDB.Internal.Bindings.html#futureIsReady"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureIsReady</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#Future"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Future</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621679085194"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- | Attempts to commit a transaction. If 'await'ing the returned 'Future'</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- works without errors, the transaction was committed.</span><span>
</span><a name="line-250"></a><span class="hs-identifier">commitFuture</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-251"></a><a name="commitFuture"><a href="FoundationDB.Transaction.html#commitFuture"><span class="hs-identifier">commitFuture</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-252"></a><span>  </span><a name="local-6989586621679085327"><a href="#local-6989586621679085327"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-253"></a><span>  </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionCommit"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionCommit</span></a><span> </span><a href="#local-6989586621679085327"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-comment">-- | Get the value of a key. If the key does not exist, returns 'Nothing'.</span><span>
</span><a name="line-256"></a><span class="hs-identifier">get</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><a name="get"><a href="FoundationDB.Transaction.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621679085328"><a href="#local-6989586621679085328"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-258"></a><span>  </span><a name="local-6989586621679085329"><a href="#local-6989586621679085329"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679085330"><a href="#local-6989586621679085330"><span class="hs-identifier">isSnapshot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">snapshotReads</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">envConf</span><span> </span><a href="#local-6989586621679085329"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>  </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionGet"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cTransaction</span><span> </span><a href="#local-6989586621679085329"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085328"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679085330"><span class="hs-identifier hs-var">isSnapshot</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679085331"><a href="#local-6989586621679085331"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#futureGetValue"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetValue</span></a><span> </span><a href="#local-6989586621679085331"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="FoundationDB.Error.Internal.html#liftFDBError"><span class="hs-identifier hs-var">liftFDBError</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- | Set a bytestring key to a bytestring value.</span><span>
</span><a name="line-264"></a><span class="hs-identifier">set</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="set"><a href="FoundationDB.Transaction.html#set"><span class="hs-identifier">set</span></a></a><span> </span><a name="local-6989586621679085332"><a href="#local-6989586621679085332"><span class="hs-identifier">key</span></a></a><span> </span><a name="local-6989586621679085333"><a href="#local-6989586621679085333"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-266"></a><span>  </span><a name="local-6989586621679085334"><a href="#local-6989586621679085334"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-267"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionSet"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionSet</span></a><span> </span><a href="#local-6989586621679085334"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085332"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679085333"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">-- | Delete a key from the DB.</span><span>
</span><a name="line-270"></a><span class="hs-identifier">clear</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-271"></a><a name="clear"><a href="FoundationDB.Transaction.html#clear"><span class="hs-identifier">clear</span></a></a><span> </span><a name="local-6989586621679085335"><a href="#local-6989586621679085335"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-272"></a><span>  </span><a name="local-6989586621679085336"><a href="#local-6989586621679085336"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-273"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionClear"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionClear</span></a><span> </span><a href="#local-6989586621679085336"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085335"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-comment">-- | @clearRange k l@ deletes all keys in the half-open range [k,l).</span><span>
</span><a name="line-276"></a><span class="hs-identifier">clearRange</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-277"></a><a name="clearRange"><a href="FoundationDB.Transaction.html#clearRange"><span class="hs-identifier">clearRange</span></a></a><span> </span><a name="local-6989586621679085337"><a href="#local-6989586621679085337"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679085338"><a href="#local-6989586621679085338"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-278"></a><span>  </span><a name="local-6989586621679085339"><a href="#local-6989586621679085339"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionClearRange"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionClearRange</span></a><span> </span><a href="#local-6989586621679085339"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085337"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679085338"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-comment">-- | Tells FoundationDB to consider the given range to have been read by this</span><span>
</span><a name="line-282"></a><span class="hs-comment">-- transaction.</span><span>
</span><a name="line-283"></a><span class="hs-identifier">addConflictRange</span><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FDBConflictRangeType"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">FDBConflictRangeType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><a name="addConflictRange"><a href="FoundationDB.Transaction.html#addConflictRange"><span class="hs-identifier">addConflictRange</span></a></a><span> </span><a name="local-6989586621679085340"><a href="#local-6989586621679085340"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679085341"><a href="#local-6989586621679085341"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679085342"><a href="#local-6989586621679085342"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-286"></a><span>  </span><a name="local-6989586621679085343"><a href="#local-6989586621679085343"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-287"></a><span>  </span><a href="FoundationDB.Error.Internal.html#fdbExcept%27"><span class="hs-identifier hs-var">fdbExcept'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionAddConflictRange"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionAddConflictRange</span></a><span> </span><a href="#local-6989586621679085343"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085340"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679085341"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679085342"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-comment">-- | Tells FoundationDB to consider the given key to have been read by this</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- transaction.</span><span>
</span><a name="line-291"></a><span class="hs-identifier">addReadConflictKey</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><a name="addReadConflictKey"><a href="FoundationDB.Transaction.html#addReadConflictKey"><span class="hs-identifier">addReadConflictKey</span></a></a><span> </span><a name="local-6989586621679085344"><a href="#local-6989586621679085344"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-293"></a><span>  </span><a href="FoundationDB.Transaction.html#addConflictRange"><span class="hs-identifier hs-var">addConflictRange</span></a><span> </span><a href="#local-6989586621679085344"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">snoc</span><span> </span><a href="#local-6989586621679085344"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-number">0x00</span><span class="hs-special">)</span><span> </span><a href="FoundationDB.Internal.Bindings.html#ConflictRangeTypeRead"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ConflictRangeTypeRead</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-comment">-- | Tells FoundationDB to consider the given key to have been written</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- by this transaction.</span><span>
</span><a name="line-297"></a><span class="hs-identifier">addWriteConflictKey</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-298"></a><a name="addWriteConflictKey"><a href="FoundationDB.Transaction.html#addWriteConflictKey"><span class="hs-identifier">addWriteConflictKey</span></a></a><span> </span><a name="local-6989586621679085345"><a href="#local-6989586621679085345"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-299"></a><span>  </span><a href="FoundationDB.Transaction.html#addConflictRange"><span class="hs-identifier hs-var">addConflictRange</span></a><span> </span><a href="#local-6989586621679085345"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">snoc</span><span> </span><a href="#local-6989586621679085345"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-number">0x00</span><span class="hs-special">)</span><span> </span><a href="FoundationDB.Internal.Bindings.html#ConflictRangeTypeWrite"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ConflictRangeTypeWrite</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-comment">-- | Increase the offset of the given 'KeySelector'.</span><span>
</span><a name="line-302"></a><span class="hs-identifier">offset</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Internal.Bindings.html#KeySelector"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KeySelector</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Internal.Bindings.html#KeySelector"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KeySelector</span></a><span>
</span><a name="line-303"></a><a name="offset"><a href="FoundationDB.Transaction.html#offset"><span class="hs-identifier">offset</span></a></a><span> </span><a name="local-6989586621679085346"><a href="#local-6989586621679085346"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#WithOffset"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">WithOffset</span></a><span> </span><a name="local-6989586621679085347"><a href="#local-6989586621679085347"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679085348"><a href="#local-6989586621679085348"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Internal.Bindings.html#WithOffset"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">WithOffset</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085347"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679085346"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085348"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-304"></a><span class="hs-identifier">offset</span><span> </span><a name="local-6989586621679085349"><a href="#local-6989586621679085349"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679085350"><a href="#local-6989586621679085350"><span class="hs-identifier">ks</span></a></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Internal.Bindings.html#WithOffset"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">WithOffset</span></a><span> </span><a href="#local-6989586621679085349"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679085350"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-comment">-- | Gets the key specified by the given 'KeySelector'.</span><span>
</span><a name="line-307"></a><span class="hs-identifier">getKey</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#KeySelector"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KeySelector</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><a name="getKey"><a href="FoundationDB.Transaction.html#getKey"><span class="hs-identifier">getKey</span></a></a><span> </span><a name="local-6989586621679085351"><a href="#local-6989586621679085351"><span class="hs-identifier">ks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-309"></a><span>  </span><a name="local-6989586621679085352"><a href="#local-6989586621679085352"><span class="hs-identifier">t</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-310"></a><span>  </span><a name="local-6989586621679085353"><a href="#local-6989586621679085353"><span class="hs-identifier">isSnapshot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">snapshotReads</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">envConf</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679085354"><a href="#local-6989586621679085354"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679085355"><a href="#local-6989586621679085355"><span class="hs-identifier">orEqual</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679085356"><a href="#local-6989586621679085356"><span class="hs-identifier">offsetN</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Internal.Bindings.html#keySelectorTuple"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keySelectorTuple</span></a><span> </span><a href="#local-6989586621679085351"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-312"></a><span>  </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionGetKey"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGetKey</span></a><span> </span><a href="#local-6989586621679085352"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085354"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679085355"><span class="hs-identifier hs-var">orEqual</span></a><span> </span><a href="#local-6989586621679085356"><span class="hs-identifier hs-var">offsetN</span></a><span> </span><a href="#local-6989586621679085353"><span class="hs-identifier hs-var">isSnapshot</span></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679085357"><a href="#local-6989586621679085357"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#futureGetKey"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetKey</span></a><span> </span><a href="#local-6989586621679085357"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="FoundationDB.Error.Internal.html#liftFDBError"><span class="hs-identifier hs-var">liftFDBError</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">-- | Get the public network addresses of all nodes responsible for storing</span><span>
</span><a name="line-316"></a><span class="hs-comment">-- the given key.</span><span>
</span><a name="line-317"></a><span class="hs-identifier">getKeyAddresses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><a name="getKeyAddresses"><a href="FoundationDB.Transaction.html#getKeyAddresses"><span class="hs-identifier">getKeyAddresses</span></a></a><span> </span><a name="local-6989586621679085358"><a href="#local-6989586621679085358"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-319"></a><span>  </span><a name="local-6989586621679085359"><a href="#local-6989586621679085359"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-320"></a><span>  </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionGetAddressesForKey"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGetAddressesForKey</span></a><span> </span><a href="#local-6989586621679085359"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085358"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679085360"><a href="#local-6989586621679085360"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#futureGetStringArray"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetStringArray</span></a><span> </span><a href="#local-6989586621679085360"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="FoundationDB.Error.Internal.html#liftFDBError"><span class="hs-identifier hs-var">liftFDBError</span></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-comment">-- TODO: rename to RangeQuery?</span><span>
</span><a name="line-324"></a><span class="hs-comment">-- | Specifies a range of keys to be iterated over by 'getRange'.</span><span>
</span><a name="line-325"></a><span class="hs-keyword">data</span><span> </span><a name="Range"><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier">Range</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Range"><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier">Range</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-326"></a><span>  </span><a name="rangeBegin"><a href="FoundationDB.Transaction.html#rangeBegin"><span class="hs-identifier">rangeBegin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#KeySelector"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KeySelector</span></a><span>
</span><a name="line-327"></a><span>  </span><span class="hs-comment">-- ^ The beginning of the range, including the key specified by this</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-comment">-- 'KeySelector'.</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="rangeEnd"><a href="FoundationDB.Transaction.html#rangeEnd"><span class="hs-identifier">rangeEnd</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#KeySelector"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KeySelector</span></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-comment">-- ^ The end of the range, not including the key specified by this</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-comment">-- 'KeySelector'.</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="rangeLimit"><a href="FoundationDB.Transaction.html#rangeLimit"><span class="hs-identifier">rangeLimit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-333"></a><span>  </span><span class="hs-comment">-- ^ If the range contains more than @n@ items, return only @Just n@.</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-comment">-- If @Nothing@ is provided, returns the entire range.</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="rangeReverse"><a href="FoundationDB.Transaction.html#rangeReverse"><span class="hs-identifier">rangeReverse</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-336"></a><span>  </span><span class="hs-comment">-- ^ If 'True', return the range in reverse order.</span><span>
</span><a name="line-337"></a><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-comment">-- | @keyRange begin end@ is the range of keys @[begin, end)@.</span><span>
</span><a name="line-340"></a><span class="hs-identifier">keyRange</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span>
</span><a name="line-341"></a><a name="keyRange"><a href="FoundationDB.Transaction.html#keyRange"><span class="hs-identifier">keyRange</span></a></a><span> </span><a name="local-6989586621679085361"><a href="#local-6989586621679085361"><span class="hs-identifier">begin</span></a></a><span> </span><a name="local-6989586621679085362"><a href="#local-6989586621679085362"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-342"></a><span>  </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-var">Range</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span> </span><a href="#local-6989586621679085361"><span class="hs-identifier hs-var">begin</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span> </span><a href="#local-6989586621679085362"><span class="hs-identifier hs-var">end</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-comment">-- | @keyRange begin end@ is the range of keys @[begin, end]@.</span><span>
</span><a name="line-345"></a><span class="hs-identifier">keyRangeInclusive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span>
</span><a name="line-346"></a><a name="keyRangeInclusive"><a href="FoundationDB.Transaction.html#keyRangeInclusive"><span class="hs-identifier">keyRangeInclusive</span></a></a><span> </span><a name="local-6989586621679085363"><a href="#local-6989586621679085363"><span class="hs-identifier">begin</span></a></a><span> </span><a name="local-6989586621679085364"><a href="#local-6989586621679085364"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-347"></a><span>  </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-var">Range</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span> </span><a href="#local-6989586621679085363"><span class="hs-identifier hs-var">begin</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterThan"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterThan</span></a><span> </span><a href="#local-6989586621679085364"><span class="hs-identifier hs-var">end</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-comment">-- | @prefixRange prefix@ is the range of all keys of which @prefix@ is a</span><span>
</span><a name="line-350"></a><span class="hs-comment">--   prefix. Returns @Nothing@ if @prefix@ is empty or contains only @0xff@.</span><span>
</span><a name="line-351"></a><span class="hs-identifier">prefixRange</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span>
</span><a name="line-352"></a><a name="prefixRange"><a href="FoundationDB.Transaction.html#prefixRange"><span class="hs-identifier">prefixRange</span></a></a><span> </span><a name="local-6989586621679085365"><a href="#local-6989586621679085365"><span class="hs-identifier">prefix</span></a></a><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679085365"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0xff</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085365"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-355"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-var">Range</span></a><span>
</span><a name="line-356"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rangeBegin</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span> </span><a href="#local-6989586621679085365"><span class="hs-identifier hs-var">prefix</span></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rangeEnd</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#prefixRangeEnd"><span class="hs-identifier hs-var">prefixRangeEnd</span></a><span> </span><a href="#local-6989586621679085365"><span class="hs-identifier hs-var">prefix</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rangeLimit</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-359"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rangeReverse</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-360"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">rangeKeys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-363"></a><a name="rangeKeys"><a href="FoundationDB.Transaction.html#rangeKeys"><span class="hs-identifier">rangeKeys</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-var">Range</span></a><span> </span><a name="local-6989586621679085366"><a href="#local-6989586621679085366"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679085367"><a href="#local-6989586621679085367"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#keySelectorBytes"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keySelectorBytes</span></a><span> </span><a href="#local-6989586621679085366"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="FoundationDB.Internal.Bindings.html#keySelectorBytes"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keySelectorBytes</span></a><span> </span><a href="#local-6989586621679085367"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-comment">-- | Structure for returning the result of 'getRange' in chunks.</span><span>
</span><a name="line-366"></a><span class="hs-keyword">data</span><span> </span><a name="RangeResult"><a href="FoundationDB.Transaction.html#RangeResult"><span class="hs-identifier">RangeResult</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-367"></a><span>  </span><a name="RangeDone"><a href="FoundationDB.Transaction.html#RangeDone"><span class="hs-identifier">RangeDone</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="RangeMore"><a href="FoundationDB.Transaction.html#RangeMore"><span class="hs-identifier">RangeMore</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="FoundationDB.Transaction.html#RangeResult"><span class="hs-identifier hs-type">RangeResult</span></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-comment">-- | Like 'getRange', but allows you to specify the streaming mode as desired.</span><span>
</span><a name="line-372"></a><span class="hs-identifier">getRange'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FDBStreamingMode"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">FDBStreamingMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="FoundationDB.Transaction.html#RangeResult"><span class="hs-identifier hs-type">RangeResult</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><a name="getRange%27"><a href="FoundationDB.Transaction.html#getRange%27"><span class="hs-identifier">getRange'</span></a></a><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-var">Range</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679085372"><a href="#local-6989586621679085372"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-374"></a><span>  </span><a name="local-6989586621679085373"><a href="#local-6989586621679085373"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-375"></a><span>  </span><a name="local-6989586621679085374"><a href="#local-6989586621679085374"><span class="hs-identifier">isSnapshot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">snapshotReads</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">envConf</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679085375"><a href="#local-6989586621679085375"><span class="hs-identifier">getR</span></a></a><span> </span><a name="local-6989586621679085376"><a href="#local-6989586621679085376"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679085377"><a href="#local-6989586621679085377"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621679085378"><a href="#local-6989586621679085378"><span class="hs-identifier">lim</span></a></a><span> </span><a name="local-6989586621679085379"><a href="#local-6989586621679085379"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionGetRange"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGetRange</span></a><span> </span><a href="#local-6989586621679085373"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679085376"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679085377"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679085378"><span class="hs-identifier hs-var">lim</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679085372"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679085379"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679085374"><span class="hs-identifier hs-var">isSnapshot</span></a><span> </span><a href="#local-6989586621679085371"><span class="hs-identifier hs-var">rangeReverse</span></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679085380"><a href="#local-6989586621679085380"><span class="hs-identifier">mk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679085375"><span class="hs-identifier hs-var">getR</span></a><span> </span><a href="#local-6989586621679085368"><span class="hs-identifier hs-var">rangeBegin</span></a><span> </span><a href="#local-6989586621679085369"><span class="hs-identifier hs-var">rangeEnd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679085370"><span class="hs-identifier hs-var">rangeLimit</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-378"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-379"></a><span>    </span><a name="local-6989586621679085381"><a href="#local-6989586621679085381"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679085382"><a href="#local-6989586621679085382"><span class="hs-identifier">bsel</span></a></a><span> </span><a name="local-6989586621679085383"><a href="#local-6989586621679085383"><span class="hs-identifier">esel</span></a></a><span> </span><a name="local-6989586621679085384"><a href="#local-6989586621679085384"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679085385"><a href="#local-6989586621679085385"><span class="hs-identifier">lim</span></a></a><span> </span><a name="local-6989586621679085386"><a href="#local-6989586621679085386"><span class="hs-identifier">fut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-380"></a><span>      </span><span class="hs-comment">-- more doesn't take into account our count limit, so we check below</span><span>
</span><a name="line-381"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679085387"><a href="#local-6989586621679085387"><span class="hs-identifier">kvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679085388"><a href="#local-6989586621679085388"><span class="hs-identifier">more</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#futureGetKeyValueArray"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetKeyValueArray</span></a><span> </span><a href="#local-6989586621679085386"><span class="hs-identifier hs-var">fut</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="FoundationDB.Error.Internal.html#liftFDBError"><span class="hs-identifier hs-var">liftFDBError</span></a><span>
</span><a name="line-382"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679085389"><a href="#local-6989586621679085389"><span class="hs-identifier">kvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><a href="#local-6989586621679085387"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-383"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679085389"><span class="hs-identifier hs-var">kvs'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-384"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-operator hs-var">:|&gt;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679085390"><a href="#local-6989586621679085390"><span class="hs-identifier">lstK</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679085388"><span class="hs-identifier hs-var">more</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679085389"><span class="hs-identifier hs-var">kvs'</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085385"><span class="hs-identifier hs-var">lim</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-385"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679086334"><a href="#local-6989586621679086334"><span class="hs-identifier">bsel'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679085371"><span class="hs-identifier hs-var">rangeReverse</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterThan"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterThan</span></a><span> </span><a href="#local-6989586621679085390"><span class="hs-identifier hs-var">lstK</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679085382"><span class="hs-identifier hs-var">bsel</span></a><span>
</span><a name="line-386"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679086335"><a href="#local-6989586621679086335"><span class="hs-identifier">esel'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679085371"><span class="hs-identifier hs-var">rangeReverse</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FirstGreaterOrEq"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FirstGreaterOrEq</span></a><span> </span><a href="#local-6989586621679085390"><span class="hs-identifier hs-var">lstK</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679085383"><span class="hs-identifier hs-var">esel</span></a><span>
</span><a name="line-387"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679086336"><a href="#local-6989586621679086336"><span class="hs-identifier">lim'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679086337"><a href="#local-6989586621679086337"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679086337"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679085389"><span class="hs-identifier hs-var">kvs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679085385"><span class="hs-identifier hs-var">lim</span></a><span>
</span><a name="line-388"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679086338"><a href="#local-6989586621679086338"><span class="hs-identifier">mk'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679085375"><span class="hs-identifier hs-var">getR</span></a><span> </span><a href="#local-6989586621679086334"><span class="hs-identifier hs-var">bsel'</span></a><span> </span><a href="#local-6989586621679086335"><span class="hs-identifier hs-var">esel'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679086336"><span class="hs-identifier hs-var">lim'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085384"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>          </span><a name="local-6989586621679086339"><a href="#local-6989586621679086339"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><a href="#local-6989586621679086338"><span class="hs-identifier hs-var">mk'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085381"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679086334"><span class="hs-identifier hs-var">bsel'</span></a><span> </span><a href="#local-6989586621679086335"><span class="hs-identifier hs-var">esel'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085384"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679086336"><span class="hs-identifier hs-var">lim'</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#RangeMore"><span class="hs-identifier hs-var">RangeMore</span></a><span> </span><a href="#local-6989586621679085389"><span class="hs-identifier hs-var">kvs'</span></a><span> </span><a href="#local-6989586621679086339"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-391"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#RangeDone"><span class="hs-identifier hs-var">RangeDone</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679085385"><span class="hs-identifier hs-var">lim</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-392"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679085389"><span class="hs-identifier hs-var">kvs'</span></a><span>
</span><a name="line-393"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679086340"><a href="#local-6989586621679086340"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679086340"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679085389"><span class="hs-identifier hs-var">kvs'</span></a><span>
</span><a name="line-394"></a><span>  </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><a href="#local-6989586621679085380"><span class="hs-identifier hs-var">mk</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679085381"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679085368"><span class="hs-identifier hs-var">rangeBegin</span></a><span> </span><a href="#local-6989586621679085369"><span class="hs-identifier hs-var">rangeEnd</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679085370"><span class="hs-identifier hs-var">rangeLimit</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">-- | Reads all key-value pairs in the specified 'Range' which are</span><span>
</span><a name="line-397"></a><span class="hs-comment">--   lexicographically greater than or equal to the 'rangeBegin' 'KeySelector'</span><span>
</span><a name="line-398"></a><span class="hs-comment">--   and lexicographically less than the 'rangeEnd' 'KeySelector'.</span><span>
</span><a name="line-399"></a><span class="hs-comment">--   Uses 'StreamingModeIterator', which assumes that you don't know ahead of</span><span>
</span><a name="line-400"></a><span class="hs-comment">--   time exactly how many pairs in the range you actually need. If you need</span><span>
</span><a name="line-401"></a><span class="hs-comment">--   them all (and they are expected to fit in memory), use 'getEntireRange'.</span><span>
</span><a name="line-402"></a><span class="hs-comment">--   For more advanced usage, use 'getRange''.</span><span>
</span><a name="line-403"></a><span class="hs-identifier">getRange</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><a href="FoundationDB.Transaction.html#RangeResult"><span class="hs-identifier hs-type">RangeResult</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><a name="getRange"><a href="FoundationDB.Transaction.html#getRange"><span class="hs-identifier">getRange</span></a></a><span> </span><a name="local-6989586621679086341"><a href="#local-6989586621679086341"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#getRange%27"><span class="hs-identifier hs-var">getRange'</span></a><span> </span><a href="#local-6989586621679086341"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="FoundationDB.Internal.Bindings.html#StreamingModeIterator"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">StreamingModeIterator</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-identifier">getEntireRange'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#FDBStreamingMode"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">FDBStreamingMode</span></a><span>
</span><a name="line-407"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span>
</span><a name="line-408"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-409"></a><a name="getEntireRange%27"><a href="FoundationDB.Transaction.html#getEntireRange%27"><span class="hs-identifier">getEntireRange'</span></a></a><span> </span><a name="local-6989586621679086342"><a href="#local-6989586621679086342"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679086343"><a href="#local-6989586621679086343"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-410"></a><span>  </span><a name="local-6989586621679086350"><a href="#local-6989586621679086350"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#getRange%27"><span class="hs-identifier hs-var">getRange'</span></a><span> </span><a href="#local-6989586621679086343"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679086342"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span>
</span><a name="line-411"></a><span>  </span><a href="#local-6989586621679086344"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679086350"><span class="hs-identifier hs-var">rr</span></a><span>
</span><a name="line-412"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-413"></a><span>  </span><a name="local-6989586621679086344"><a href="#local-6989586621679086344"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#RangeDone"><span class="hs-identifier hs-var">RangeDone</span></a><span> </span><a name="local-6989586621679086345"><a href="#local-6989586621679086345"><span class="hs-identifier">xs</span></a></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679086345"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-414"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#RangeMore"><span class="hs-identifier hs-var">RangeMore</span></a><span> </span><a name="local-6989586621679086346"><a href="#local-6989586621679086346"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621679086347"><a href="#local-6989586621679086347"><span class="hs-identifier">fut</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-415"></a><span>    </span><a name="local-6989586621679086348"><a href="#local-6989586621679086348"><span class="hs-identifier">more</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span> </span><a href="#local-6989586621679086347"><span class="hs-identifier hs-var">fut</span></a><span>
</span><a name="line-416"></a><span>    </span><a name="local-6989586621679086349"><a href="#local-6989586621679086349"><span class="hs-identifier">ys</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679086344"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679086348"><span class="hs-identifier hs-var">more</span></a><span>
</span><a name="line-417"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679086346"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679086349"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- | Wrapper around 'getRange' that reads the entire range into memory.</span><span>
</span><a name="line-420"></a><span class="hs-identifier">getEntireRange</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-421"></a><a name="getEntireRange"><a href="FoundationDB.Transaction.html#getEntireRange"><span class="hs-identifier">getEntireRange</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#getEntireRange%27"><span class="hs-identifier hs-var">getEntireRange'</span></a><span> </span><a href="FoundationDB.Internal.Bindings.html#StreamingModeWantAll"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">StreamingModeWantAll</span></a><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-comment">-- | Return True iff the given range is empty.</span><span>
</span><a name="line-424"></a><span class="hs-identifier">isRangeEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Range"><span class="hs-identifier hs-type">Range</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-425"></a><a name="isRangeEmpty"><a href="FoundationDB.Transaction.html#isRangeEmpty"><span class="hs-identifier">isRangeEmpty</span></a></a><span> </span><a name="local-6989586621679086351"><a href="#local-6989586621679086351"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>  </span><a name="local-6989586621679086352"><a href="#local-6989586621679086352"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#getRange"><span class="hs-identifier hs-var">getRange</span></a><span> </span><a href="#local-6989586621679086351"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span>
</span><a name="line-427"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679086352"><span class="hs-identifier hs-var">rr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-428"></a><span>    </span><a href="FoundationDB.Transaction.html#RangeDone"><span class="hs-identifier hs-var">RangeDone</span></a><span> </span><span class="hs-identifier hs-var">Empty</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-429"></a><span>    </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-- | Perform an atomic operation of 'MutationType' on the given key. A</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- transaction that performs only atomic operations is guaranteed not to</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- conflict. However, it may cause other concurrent transactions to conflict.</span><span>
</span><a name="line-434"></a><span class="hs-identifier">atomicOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Options.html#MutationType"><span class="hs-identifier hs-type">Opt</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">MutationType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><a name="atomicOp"><a href="FoundationDB.Transaction.html#atomicOp"><span class="hs-identifier">atomicOp</span></a></a><span> </span><a name="local-6989586621679086353"><a href="#local-6989586621679086353"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679086354"><a href="#local-6989586621679086354"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-436"></a><span>  </span><a name="local-6989586621679086355"><a href="#local-6989586621679086355"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-437"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionAtomicOp"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionAtomicOp</span></a><span> </span><a href="#local-6989586621679086355"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679086353"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679086354"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-comment">-- | Attempts to commit a transaction against the given database. If an</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- unretryable error occurs, throws an 'Error'. Attempts to retry the</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- transaction for retryable errors.</span><span>
</span><a name="line-442"></a><span class="hs-identifier">runTransaction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Database"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085075"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679085075"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-443"></a><a name="runTransaction"><a href="FoundationDB.Transaction.html#runTransaction"><span class="hs-identifier">runTransaction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#runTransactionWithConfig"><span class="hs-identifier hs-var">runTransactionWithConfig</span></a><span> </span><a href="FoundationDB.Transaction.html#defaultConfig"><span class="hs-identifier hs-var">defaultConfig</span></a><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-comment">-- | Like 'runTransaction', but returns a sum instead of throwing an exception</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- on errors.</span><span>
</span><a name="line-447"></a><span class="hs-identifier">runTransaction'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Database"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085074"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="#local-6989586621679085074"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><a name="runTransaction%27"><a href="FoundationDB.Transaction.html#runTransaction%27"><span class="hs-identifier">runTransaction'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#runTransactionWithConfig%27"><span class="hs-identifier hs-var">runTransactionWithConfig'</span></a><span> </span><a href="FoundationDB.Transaction.html#defaultConfig"><span class="hs-identifier hs-var">defaultConfig</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-comment">-- | A config for a non-idempotent transaction, allowing 5 retries, with a time</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- limit of 500 milliseconds.</span><span>
</span><a name="line-452"></a><span class="hs-identifier">defaultConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a><span>
</span><a name="line-453"></a><a name="defaultConfig"><a href="FoundationDB.Transaction.html#defaultConfig"><span class="hs-identifier">defaultConfig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-var">TransactionConfig</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-number">500</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-comment">-- | Contains useful options that are not directly exposed by the C API (for</span><span>
</span><a name="line-456"></a><span class="hs-comment">--   options that are, see 'setOption').</span><span>
</span><a name="line-457"></a><span class="hs-keyword">data</span><span> </span><a name="TransactionConfig"><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier">TransactionConfig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TransactionConfig"><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier">TransactionConfig</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-458"></a><span>  </span><a name="idempotent"><a href="FoundationDB.Transaction.html#idempotent"><span class="hs-identifier">idempotent</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-459"></a><span>  </span><span class="hs-comment">-- ^ When set to 'True' (default is 'False'), running the transaction will</span><span>
</span><a name="line-460"></a><span>  </span><span class="hs-comment">-- retry even on errors where the transaction may have completed successfully.</span><span>
</span><a name="line-461"></a><span>  </span><span class="hs-comment">-- When 'False', the transaction will retry only when it is guaranteed that</span><span>
</span><a name="line-462"></a><span>  </span><span class="hs-comment">-- the transaction was not committed.</span><span>
</span><a name="line-463"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="snapshotReads"><a href="FoundationDB.Transaction.html#snapshotReads"><span class="hs-identifier">snapshotReads</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-464"></a><span>  </span><span class="hs-comment">-- ^ When set to 'True' (default is 'False'), reads will see the effects of</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-comment">-- concurrent transactions, removing the default serializable isolation</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-comment">-- guarantee. To enable this feature selectively within a transaction,</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-comment">-- see 'withSnapshot'.</span><span>
</span><a name="line-468"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="maxRetries"><a href="FoundationDB.Transaction.html#maxRetries"><span class="hs-identifier">maxRetries</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-469"></a><span>  </span><span class="hs-comment">-- ^ Max number of times to retry retryable errors. After this many retries,</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-comment">-- 'MaxRetriesExceeded' will be thrown to the caller of 'runTransaction'.</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="timeout"><a href="FoundationDB.Transaction.html#timeout"><span class="hs-identifier">timeout</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-comment">-- ^ Max number of milliseconds the transaction is allowed to run. If this</span><span>
</span><a name="line-473"></a><span>  </span><span class="hs-comment">-- number is exceeded, the transaction fails with an error.</span><span>
</span><a name="line-474"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- | Attempt to commit a transaction against the given database. If an</span><span>
</span><a name="line-477"></a><span class="hs-comment">-- unretryable error occurs, throws an 'Error'. Attempts to retry the</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- transaction for retryable errors.</span><span>
</span><a name="line-479"></a><span class="hs-identifier">runTransactionWithConfig</span><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Database"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085073"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679085073"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-481"></a><a name="runTransactionWithConfig"><a href="FoundationDB.Transaction.html#runTransactionWithConfig"><span class="hs-identifier">runTransactionWithConfig</span></a></a><span> </span><a name="local-6989586621679086356"><a href="#local-6989586621679086356"><span class="hs-identifier">conf</span></a></a><span> </span><a name="local-6989586621679086357"><a href="#local-6989586621679086357"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679086358"><a href="#local-6989586621679086358"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-482"></a><span>  </span><a name="local-6989586621679086359"><a href="#local-6989586621679086359"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#runTransactionWithConfig%27"><span class="hs-identifier hs-var">runTransactionWithConfig'</span></a><span> </span><a href="#local-6989586621679086356"><span class="hs-identifier hs-var">conf</span></a><span> </span><a href="#local-6989586621679086357"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="#local-6989586621679086358"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-483"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679086359"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-484"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679086360"><a href="#local-6989586621679086360"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><a href="#local-6989586621679086360"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-485"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679086361"><a href="#local-6989586621679086361"><span class="hs-identifier">x</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679086361"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-comment">-- | Handles the retry logic described in the FDB docs.</span><span>
</span><a name="line-488"></a><span class="hs-comment">-- https://apple.github.io/foundationdb/api-c.html#c.fdb_transaction_on_error</span><span>
</span><a name="line-489"></a><span class="hs-identifier">withRetry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085072"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085072"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-490"></a><a name="withRetry"><a href="FoundationDB.Transaction.html#withRetry"><span class="hs-identifier">withRetry</span></a></a><span> </span><a name="local-6989586621679086362"><a href="#local-6989586621679086362"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catchError</span><span> </span><a href="#local-6989586621679086362"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679086363"><a href="#local-6989586621679086363"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-491"></a><span>  </span><a name="local-6989586621679086364"><a href="#local-6989586621679086364"><span class="hs-identifier">idem</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">idempotent</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">envConf</span><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>  </span><a name="local-6989586621679086365"><a href="#local-6989586621679086365"><span class="hs-identifier">retriesRemaining</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxRetries</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">envConf</span><span class="hs-special">)</span><span>
</span><a name="line-493"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679086366"><a href="#local-6989586621679086366"><span class="hs-identifier">shouldRetry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679086364"><span class="hs-identifier hs-var">idem</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="FoundationDB.Error.Internal.html#retryable"><span class="hs-identifier hs-var">retryable</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="FoundationDB.Error.Internal.html#retryableNotCommitted"><span class="hs-identifier hs-var">retryableNotCommitted</span></a><span>
</span><a name="line-494"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679086366"><span class="hs-identifier hs-var">shouldRetry</span></a><span> </span><a href="#local-6989586621679086363"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679086365"><span class="hs-identifier hs-var">retriesRemaining</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-496"></a><span>      </span><a href="FoundationDB.Transaction.html#onError"><span class="hs-identifier hs-var">onError</span></a><span> </span><a href="#local-6989586621679086363"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-497"></a><span>      </span><span class="hs-comment">-- onError re-throws unretryable errors, so if we reach here, we can retry</span><span>
</span><a name="line-498"></a><span>      </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679086367"><a href="#local-6989586621679086367"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679086367"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">envConf</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">envConf</span><span> </span><a href="#local-6989586621679086367"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">maxRetries</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679086365"><span class="hs-identifier hs-var">retriesRemaining</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>            </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#withRetry"><span class="hs-identifier hs-var">withRetry</span></a><span> </span><a href="#local-6989586621679086362"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679086365"><span class="hs-identifier hs-var">retriesRemaining</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-501"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Error.Internal.html#MaxRetriesExceeded"><span class="hs-identifier hs-var">MaxRetriesExceeded</span></a><span> </span><a href="#local-6989586621679086363"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-502"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><a href="#local-6989586621679086363"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-comment">-- Attempt to commit a transaction against the given database. If an unretryable</span><span>
</span><a name="line-505"></a><span class="hs-comment">-- error occurs, returns 'Left'. Attempts to retry the transaction for retryable</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- errors.</span><span>
</span><a name="line-507"></a><span class="hs-identifier">runTransactionWithConfig'</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Database"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085071"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="#local-6989586621679085071"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><a name="runTransactionWithConfig%27"><a href="FoundationDB.Transaction.html#runTransactionWithConfig%27"><span class="hs-identifier">runTransactionWithConfig'</span></a></a><span> </span><a name="local-6989586621679086368"><a href="#local-6989586621679086368"><span class="hs-identifier">conf</span></a></a><span> </span><a name="local-6989586621679086369"><a href="#local-6989586621679086369"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679086370"><a href="#local-6989586621679086370"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runResourceT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-510"></a><span>  </span><a name="local-6989586621679086371"><a href="#local-6989586621679086371"><span class="hs-identifier">trans</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#createTransactionEnv"><span class="hs-identifier hs-var">createTransactionEnv</span></a><span> </span><a href="#local-6989586621679086369"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="#local-6989586621679086368"><span class="hs-identifier hs-var">conf</span></a><span>
</span><a name="line-511"></a><span>  </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679086371"><span class="hs-identifier hs-var">trans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unTransaction</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#withRetry"><span class="hs-identifier hs-var">withRetry</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-512"></a><span>    </span><a href="FoundationDB.Transaction.html#setOption"><span class="hs-identifier hs-var">setOption</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Options.html#timeout"><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">timeout</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">timeout</span><span> </span><a href="#local-6989586621679086368"><span class="hs-identifier hs-var">conf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>    </span><a name="local-6989586621679086372"><a href="#local-6989586621679086372"><span class="hs-identifier">res</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679086370"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-514"></a><span>    </span><a name="local-6989586621679086373"><a href="#local-6989586621679086373"><span class="hs-identifier">commit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#commitFuture"><span class="hs-identifier hs-var">commitFuture</span></a><span>
</span><a name="line-515"></a><span>    </span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span> </span><a href="#local-6989586621679086373"><span class="hs-identifier hs-var">commit</span></a><span>
</span><a name="line-516"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679086372"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-comment">-- | Cancel a transaction. The transaction will not be committed, and</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- will throw 'TransactionCanceled'.</span><span>
</span><a name="line-520"></a><span class="hs-identifier">cancel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-521"></a><a name="cancel"><a href="FoundationDB.Transaction.html#cancel"><span class="hs-identifier">cancel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-522"></a><span>  </span><a name="local-6989586621679086374"><a href="#local-6989586621679086374"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-523"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionCancel"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionCancel</span></a><span> </span><a href="#local-6989586621679086374"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Error.Internal.html#CError"><span class="hs-identifier hs-var">CError</span></a><span> </span><a href="FoundationDB.Error.Internal.html#TransactionCanceled"><span class="hs-identifier hs-var">TransactionCanceled</span></a><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span class="hs-comment">-- | Reset the transaction. All operations prior to this will be discarded.</span><span>
</span><a name="line-527"></a><span class="hs-identifier">reset</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-528"></a><a name="reset"><a href="FoundationDB.Transaction.html#reset"><span class="hs-identifier">reset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-529"></a><span>  </span><a name="local-6989586621679086375"><a href="#local-6989586621679086375"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-530"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionReset"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionReset</span></a><span> </span><a href="#local-6989586621679086375"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-comment">-- | Runs a transaction using snapshot reads, which means that the transaction</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- will see the results of concurrent transactions, removing the default</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- serializable isolation guarantee.</span><span>
</span><a name="line-535"></a><span class="hs-identifier">withSnapshot</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085070"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085070"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-536"></a><a name="withSnapshot"><a href="FoundationDB.Transaction.html#withSnapshot"><span class="hs-identifier">withSnapshot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679086376"><a href="#local-6989586621679086376"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-537"></a><span>  </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-var">TransactionEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cTransaction</span><span> </span><a href="#local-6989586621679086376"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">envConf</span><span> </span><a href="#local-6989586621679086376"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">snapshotReads</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-comment">-- | Sets the read version on the current transaction. As the FoundationDB docs</span><span>
</span><a name="line-540"></a><span class="hs-comment">-- state, &quot;this is not needed in simple cases&quot;.</span><span>
</span><a name="line-541"></a><span class="hs-identifier">setReadVersion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-542"></a><a name="setReadVersion"><a href="FoundationDB.Transaction.html#setReadVersion"><span class="hs-identifier">setReadVersion</span></a></a><span> </span><a name="local-6989586621679086377"><a href="#local-6989586621679086377"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-543"></a><span>  </span><a name="local-6989586621679086378"><a href="#local-6989586621679086378"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-544"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionSetReadVersion"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionSetReadVersion</span></a><span> </span><a href="#local-6989586621679086378"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679086377"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-comment">-- | Gets the read version of the current transaction, representing all</span><span>
</span><a name="line-547"></a><span class="hs-comment">-- transactions that were reported committed before this one.</span><span>
</span><a name="line-548"></a><span class="hs-identifier">getReadVersion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-549"></a><a name="getReadVersion"><a href="FoundationDB.Transaction.html#getReadVersion"><span class="hs-identifier">getReadVersion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-550"></a><span>  </span><a name="local-6989586621679086379"><a href="#local-6989586621679086379"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-551"></a><span>  </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionGetReadVersion"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGetReadVersion</span></a><span> </span><a href="#local-6989586621679086379"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679086380"><a href="#local-6989586621679086380"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="FoundationDB.Error.Internal.html#fdbExcept"><span class="hs-identifier hs-var">fdbExcept</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#futureGetVersion"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetVersion</span></a><span> </span><a href="#local-6989586621679086380"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-comment">-- | Returns a 'FutureIO' that will resolve to the versionstamp of the committed</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- transaction. Most applications won't need this.</span><span>
</span><a name="line-556"></a><span class="hs-identifier">getVersionstamp</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="FoundationDB.Versionstamp.Internal.html#TransactionVersionstamp"><span class="hs-identifier hs-type">TransactionVersionstamp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-558"></a><a name="getVersionstamp"><a href="FoundationDB.Transaction.html#getVersionstamp"><span class="hs-identifier">getVersionstamp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-559"></a><span>  </span><a name="local-6989586621679086381"><a href="#local-6989586621679086381"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-560"></a><span>  </span><a name="local-6989586621679086382"><a href="#local-6989586621679086382"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionGetVersionstamp"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGetVersionstamp</span></a><span> </span><a href="#local-6989586621679086381"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#allocFutureIO"><span class="hs-identifier hs-var">allocFutureIO</span></a><span> </span><a href="#local-6989586621679086382"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#futureGetKey"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">futureGetKey</span></a><span> </span><a href="#local-6989586621679086382"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-562"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679086383"><a href="#local-6989586621679086383"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="FoundationDB.Error.Internal.html#CError"><span class="hs-identifier hs-var">CError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Error.Internal.html#toError"><span class="hs-identifier hs-var">toError</span></a><span> </span><a href="#local-6989586621679086383"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679086384"><a href="#local-6989586621679086384"><span class="hs-identifier">bs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FoundationDB.Versionstamp.Internal.html#decodeTransactionVersionstamp"><span class="hs-identifier hs-var">decodeTransactionVersionstamp</span></a><span> </span><a href="#local-6989586621679086384"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-564"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-565"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-566"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-567"></a><span>        </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-var">Error</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-568"></a><span>        </span><a href="FoundationDB.Error.Internal.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Failed to parse versionstamp: &quot;</span><span>
</span><a name="line-569"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679086384"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-570"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679086385"><a href="#local-6989586621679086385"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679086385"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span class="hs-comment">-- | Creates a future that will be fulfilled when the value</span><span>
</span><a name="line-573"></a><span class="hs-comment">-- associated with the given key is changed, relative to the value</span><span>
</span><a name="line-574"></a><span class="hs-comment">-- it had as of the current transaction's read version, or the last</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- value to which the key was previously set within the current</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- transaction. This future is safe to return from the transaction</span><span>
</span><a name="line-577"></a><span class="hs-comment">-- and await in IO. If the transaction in which it was created</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- fails to commit, awaiting it will return the same error as</span><span>
</span><a name="line-579"></a><span class="hs-comment">-- running the transaction did.</span><span>
</span><a name="line-580"></a><span class="hs-identifier">watch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#FutureIO"><span class="hs-identifier hs-type">FutureIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-581"></a><a name="watch"><a href="FoundationDB.Transaction.html#watch"><span class="hs-identifier">watch</span></a></a><span> </span><a name="local-6989586621679086386"><a href="#local-6989586621679086386"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-582"></a><span>  </span><a name="local-6989586621679086387"><a href="#local-6989586621679086387"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-583"></a><span>  </span><a name="local-6989586621679086388"><a href="#local-6989586621679086388"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionWatch"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionWatch</span></a><span> </span><a href="#local-6989586621679086387"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679086386"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-584"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Transaction.html#allocFutureIO"><span class="hs-identifier hs-var">allocFutureIO</span></a><span> </span><a href="#local-6989586621679086388"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-comment">-- | Set one of the transaction options from the underlying C API.</span><span>
</span><a name="line-588"></a><span class="hs-identifier">setOption</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Options.html#TransactionOption"><span class="hs-identifier hs-type">Opt</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TransactionOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-589"></a><a name="setOption"><a href="FoundationDB.Transaction.html#setOption"><span class="hs-identifier">setOption</span></a></a><span> </span><a name="local-6989586621679086389"><a href="#local-6989586621679086389"><span class="hs-identifier">opt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-590"></a><span>  </span><a name="local-6989586621679086390"><a href="#local-6989586621679086390"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-591"></a><span>  </span><a href="FoundationDB.Error.Internal.html#fdbExcept%27"><span class="hs-identifier hs-var">fdbExcept'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionSetOption"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionSetOption</span></a><span> </span><a href="#local-6989586621679086390"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679086389"><span class="hs-identifier hs-var">opt</span></a><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span class="hs-comment">{- $advanced
   The functionality in this section is for more advanced use cases where you
   need to be able to refer to an in-progress transaction and add operations to
   it incrementally. This is similar to how the Python's bindings work -- you
   pass around a transaction object and call methods on it one by one before
   finally calling @.commit()@.

   This functionality was needed to create the bindings tester, which is
   required to follow the semantics of the bindings for imperative languages
   more closely. You probably don't need this. In fact, it's not entirely clear
   that the bindings tester needs it.
-}</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-comment">-- | The internal state of a transaction as it is being executed by</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- 'runTransaction'.</span><span>
</span><a name="line-608"></a><span class="hs-keyword">data</span><span> </span><a name="TransactionEnv"><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier">TransactionEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TransactionEnv"><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier">TransactionEnv</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-609"></a><span>  </span><a name="cTransaction"><a href="FoundationDB.Transaction.html#cTransaction"><span class="hs-identifier">cTransaction</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Transaction"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Transaction</span></a><span>
</span><a name="line-610"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="envConf"><a href="FoundationDB.Transaction.html#envConf"><span class="hs-identifier">envConf</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a><span>
</span><a name="line-611"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span class="hs-identifier">createTransactionEnv</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Internal.Bindings.html#Database"><span class="hs-identifier hs-type">FDB</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Database</span></a><span>
</span><a name="line-615"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a><span>
</span><a name="line-616"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ResourceT</span><span> </span><span class="hs-identifier hs-type">IO</span><span class="hs-special">)</span><span> </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-type">TransactionEnv</span></a><span>
</span><a name="line-617"></a><a name="createTransactionEnv"><a href="FoundationDB.Transaction.html#createTransactionEnv"><span class="hs-identifier">createTransactionEnv</span></a></a><span> </span><a name="local-6989586621679086391"><a href="#local-6989586621679086391"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679086392"><a href="#local-6989586621679086392"><span class="hs-identifier">config</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-618"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679086393"><a href="#local-6989586621679086393"><span class="hs-identifier">_rk</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679086394"><a href="#local-6989586621679086394"><span class="hs-identifier">eTrans</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">allocate</span><span>
</span><a name="line-619"></a><span>    </span><span class="hs-special">(</span><a href="FoundationDB.Error.Internal.html#fdbEither"><span class="hs-identifier hs-var">fdbEither</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FoundationDB.Internal.Bindings.html#databaseCreateTransaction"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">databaseCreateTransaction</span></a><span> </span><a href="#local-6989586621679086391"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="FoundationDB.Internal.Bindings.html#transactionDestroy"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionDestroy</span></a><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>  </span><span class="hs-identifier hs-var">liftEither</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-var">TransactionEnv</span></a><span> </span><a href="#local-6989586621679086392"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679086394"><span class="hs-identifier hs-var">eTrans</span></a><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span class="hs-comment">-- | Execute a transactional action on an existing transaction environment.</span><span>
</span><a name="line-624"></a><span class="hs-identifier">onEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#TransactionEnv"><span class="hs-identifier hs-type">TransactionEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><a href="#local-6989586621679085069"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="#local-6989586621679085069"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-625"></a><a name="onEnv"><a href="FoundationDB.Transaction.html#onEnv"><span class="hs-identifier">onEnv</span></a></a><span> </span><a name="local-6989586621679086395"><a href="#local-6989586621679086395"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-var">Transaction</span></a><span> </span><a name="local-6989586621679086396"><a href="#local-6989586621679086396"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runResourceT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679086396"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679086395"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-comment">-- | Calls the C API's @fdb_transaction_on_error@ function. Re-raises</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- unretryable errors.</span><span>
</span><a name="line-629"></a><span class="hs-identifier">onError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Error.Internal.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-630"></a><a name="onError"><a href="FoundationDB.Transaction.html#onError"><span class="hs-identifier">onError</span></a></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Error.Internal.html#CError"><span class="hs-identifier hs-var">CError</span></a><span> </span><a name="local-6989586621679086397"><a href="#local-6989586621679086397"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-631"></a><span>  </span><a name="local-6989586621679086398"><a href="#local-6989586621679086398"><span class="hs-identifier">trans</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-632"></a><span>  </span><a name="local-6989586621679086399"><a href="#local-6989586621679086399"><span class="hs-identifier">f</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FoundationDB.Transaction.html#allocFuture"><span class="hs-identifier hs-var">allocFuture</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionOnError"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionOnError</span></a><span> </span><a href="#local-6989586621679086398"><span class="hs-identifier hs-var">trans</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Error.Internal.html#toCFDBError"><span class="hs-identifier hs-var">toCFDBError</span></a><span> </span><a href="#local-6989586621679086397"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-634"></a><span>  </span><a href="FoundationDB.Transaction.html#await"><span class="hs-identifier hs-var">await</span></a><span> </span><a href="#local-6989586621679086399"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-635"></a><span class="hs-identifier">onError</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-comment">-- @prefixRangeEnd prefix@ returns the lexicographically greatest bytestring</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- of which @prefix@ is a prefix. Usually, it's easier to just use</span><span>
</span><a name="line-639"></a><span class="hs-comment">-- 'prefixRange'.</span><span>
</span><a name="line-640"></a><span class="hs-identifier">prefixRangeEnd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-641"></a><a name="prefixRangeEnd"><a href="FoundationDB.Transaction.html#prefixRangeEnd"><span class="hs-identifier">prefixRangeEnd</span></a></a><span> </span><a name="local-6989586621679086400"><a href="#local-6989586621679086400"><span class="hs-identifier">prefix</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-642"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679086401"><a href="#local-6989586621679086401"><span class="hs-identifier">prefix'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0xff</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679086400"><span class="hs-identifier hs-var">prefix</span></a><span>
</span><a name="line-643"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">snoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621679086401"><span class="hs-identifier hs-var">prefix'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621679086401"><span class="hs-identifier hs-var">prefix'</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">-- | Gets the committed version of a transaction. Can only be called after the</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- transaction has committed, so must be used in conjunction with</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- 'TransactionEnv', since 'runTransaction' and its variants immediately destroy</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- the internal 'TransactionEnv' as soon as they return.</span><span>
</span><a name="line-649"></a><span class="hs-identifier">getCommittedVersion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FoundationDB.Transaction.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-650"></a><a name="getCommittedVersion"><a href="FoundationDB.Transaction.html#getCommittedVersion"><span class="hs-identifier">getCommittedVersion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-651"></a><span>  </span><a name="local-6989586621679086402"><a href="#local-6989586621679086402"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">cTransaction</span><span>
</span><a name="line-652"></a><span>  </span><a href="FoundationDB.Error.Internal.html#fdbExcept"><span class="hs-identifier hs-var">fdbExcept</span></a><span> </span><span class="hs-special">(</span><a href="FoundationDB.Internal.Bindings.html#transactionGetCommittedVersion"><span class="hs-identifier hs-var">FDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">transactionGetCommittedVersion</span></a><span> </span><a href="#local-6989586621679086402"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-653"></a></pre></body></html>